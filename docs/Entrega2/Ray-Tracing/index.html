<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Entrega 2 - Ray Tracing # Ray tracing # Introducción # El ray tracing es una de las dos soluciones más populares dadas para el renderizado de objetos de tres dimensiones en pantallas de sólo dos. Esta técnica permite la creación de imágenes que se asemejan a la realidad de una forma relativamente sencilla. A continuación se muestra la historia de la técnica, la teoría que se encuentra detrás y una aplicación que permite visualizar a rasgos generales como es el funcionamiento del ray tracing, es decir la realización de una prueba de concepto."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="(2) Ray Tracing"><meta property="og:description" content="Entrega 2 - Ray Tracing # Ray tracing # Introducción # El ray tracing es una de las dos soluciones más populares dadas para el renderizado de objetos de tres dimensiones en pantallas de sólo dos. Esta técnica permite la creación de imágenes que se asemejan a la realidad de una forma relativamente sencilla. A continuación se muestra la historia de la técnica, la teoría que se encuentra detrás y una aplicación que permite visualizar a rasgos generales como es el funcionamiento del ray tracing, es decir la realización de una prueba de concepto."><meta property="og:type" content="article"><meta property="og:url" content="https://vcwork.github.io/project/docs/Entrega2/Ray-Tracing/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-06-14T22:33:46-05:00"><title>(2) Ray Tracing | Showcase Template</title><link rel=manifest href=/project/manifest.json><link rel=icon href=/project/favicon.png type=image/x-icon><link rel=stylesheet href=/project/book.min.ab46de3e725a6415339a37bba23a0067534a37289b063c9f8d011515a63097a8.css integrity="sha256-q0bePnJaZBUzmje7ojoAZ1NKNyibBjyfjQEVFaYwl6g=" crossorigin=anonymous><script defer src=/project/flexsearch.min.js></script>
<script defer src=/project/en.search.min.059046e3d53e45e778e3cebd570e168b5992472f41fe473d6f5a50cf69526235.js integrity="sha256-BZBG49U+Red44869Vw4Wi1mSRy9B/kc9b1pQz2lSYjU=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/project/><span>Showcase Template</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/project/docs/ilusiones/>Entrega 1</a></li><li><input type=checkbox id=section-1c2a9454c2f3625c9b60a69e31250130 class=toggle checked>
<label for=section-1c2a9454c2f3625c9b60a69e31250130 class="flex justify-between"><a role=button>Entrega 2</a></label><ul><li><a href=/project/docs/Entrega2/3Dbrush/>(1) 3D Brush</a></li><li><a href=/project/docs/Entrega2/Ray-Tracing/ class=active>(2) Ray Tracing</a></li><li><a href=/project/docs/Entrega2/rendering/>(3) Renderización en software</a></li></ul></li><li><input type=checkbox id=section-394698d7d249dcdae2cc71d29618744e class=toggle>
<label for=section-394698d7d249dcdae2cc71d29618744e class="flex justify-between"><a role=button>Entrega 3</a></label><ul><li><a href=/project/docs/Entrega3/ShaderExer/>(1) Óscar</a></li><li><a href=/project/docs/Entrega3/gerson_codes/>(2) Gerson Nicolás Pineda</a></li><li><a href=/project/docs/Entrega3/Fernando/>(3) Fernando Moreno Bautista</a></li><li><a href=/project/docs/Entrega3/parte1/>Parte I</a></li><li><a href=/project/docs/Entrega3/parte2/>Parte II</a></li><li><a href=/project/docs/Entrega3/parte3/>Parte III</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/project/svg/menu.svg class=book-icon alt=Menu></label>
<strong>(2) Ray Tracing</strong>
<label for=toc-control><img src=/project/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#entrega-2---ray-tracing>Entrega 2 - Ray Tracing</a><ul><li><a href=#ray-tracing>Ray tracing</a></li><li><a href=#introducción>Introducción</a></li><li><a href=#contexto>Contexto</a><ul><li><a href=#historia>Historia</a></li><li><a href=#funcionamiento>Funcionamiento</a></li></ul></li><li><a href=#resultados>Resultados</a></li><li><a href=#conclusiones-y-trabajo-futuro>Conclusiones y trabajo futuro</a></li><li><a href=#recursos>Recursos</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=entrega-2---ray-tracing>Entrega 2 - Ray Tracing
<a class=anchor href=#entrega-2---ray-tracing>#</a></h1><h2 id=ray-tracing>Ray tracing
<a class=anchor href=#ray-tracing>#</a></h2><h2 id=introducción>Introducción
<a class=anchor href=#introducci%c3%b3n>#</a></h2><p>El ray tracing es una de las dos soluciones más populares dadas para el renderizado de objetos de tres dimensiones en pantallas de sólo dos. Esta técnica permite la creación de imágenes que se asemejan a la realidad de una forma relativamente sencilla. A continuación se muestra la historia de la técnica, la teoría que se encuentra detrás y una aplicación que permite visualizar a rasgos generales como es el funcionamiento del ray tracing, es decir la realización de una prueba de concepto. De la revisión del marco teórico es posible concluir que esta técnica es cada vez más usada debido a los adelantos computacionales y las nuevas necesidades que surgen en la computación gráfica.</p><h2 id=contexto>Contexto
<a class=anchor href=#contexto>#</a></h2><h3 id=historia>Historia
<a class=anchor href=#historia>#</a></h3><p>Con la finalidad de obtener en las pantallas objetos cada vez más parecidos a los que se encuentran en la realidad se comenzó a intentar producir los gráficos con conceptos de física, en donde era posible ver mediante los rayos de luz que llegaban al observador, este proceso en el cual se seguía un rayo de luz que salía de una fuente de luz hasta llegar al observador para formar una imagen fue llamado Ray Tracing. En el momento en el que se tuvo el concepto y la idea de realizar este tipo de procesado de las imágenes no era posible debido a su costo computacional (1960). Con el paso del tiempo se ha podido mejorar los algoritmos y además se tiene mayor capacidad de cómputo con lo cual se ha llegado al tratamiento de aspectos cada vez más complejos como lo son los reflejos, las sombras o el efecto que se produce en las imágenes en movimiento (Glassner, 2019).</p><h3 id=funcionamiento>Funcionamiento
<a class=anchor href=#funcionamiento>#</a></h3><p>Como ya se había señalado anteriormente, el Ray Tracing se inspira en la física de la visión, por lo tanto se parte de un punto focal que vendría a ser el ojo del observador al cual llegan los rayos de luz, además se tiene un plano de proyección que es en el cual se verá la imagen, este es el que será emulado por la pantalla en donde se esté observando la imagen, este plano usualmente se subdivide en la cantidad de pixeles que tiene la pantalla. Si se parte de una fuente de luz esta rebota en los objetos y pasa directamente hacia el plano de proyección y después impacta contra el punto focal tal y como se muestra en la siguiente imagen retomada de Redmon(2011):</p><p align=center><img src=/project/sketches/ray1.png width=500></p><p>Sin embargo, este enfoque aunque correcto no es muy práctico, esto debido a la cantidad de rayos de luz o fotones que se encuentran rondado en una imagen o en el mundo real, ademas solo son necesarios para la computación gráfica los rayos que llegan al punto focal, por lo que se cambia el enfoque. Para el ray tracing se parte del punto focal que hace pasar los rayos de luz por cada uno de los puntos del plano de proyección se renderiza la imagen a partir de algunas propiedades que se dan al impactar el rayo contra los objetos que se encuentran en la imagen, entonces el algoritmo se basa en encontrar el punto de intersección más cercano del rayo con el objeto de la imagen y renderizar en el plano de proyección alguna imagen de acuerdo con la distancia de la intersección al punto focal, en donde además se pueden tener en cuenta otros factores como el color o la capacidad de absorber luz que tiene el objeto sobre el cual impacta el rayo (Redmon, 2011).</p><p align=center><img src=/project/sketches/ray2.png width=500></p><h2 id=resultados>Resultados
<a class=anchor href=#resultados>#</a></h2><p>Con el fin de demostrar el concepto se puede realizar el trazado de los rayos para renderizar una esfera, para esto es necesario primero determinar el sistema de referencia y con esto poder renderizar sobre el plano de proyección es decir determinar la relación entre el plano y los píxeles de la pantalla, además cuando el rayo impacte sobre el rayo es necesario saber que color sera el que se dibujara sobre le plano y por último colorear el pixel correspondiente, acontinuación se muestran los desarrollados realizados por Gambetta (2021). Para comenzar se realiza la relación entre rayos de luz y los píxeles:</p><p><link rel=stylesheet href=/project/katex/katex.min.css><script defer src=/project/katex/katex.min.js></script>
<script defer src=/project/katex/auto-render.min.js onload=renderMathInElement(document.body)></script><span>
\[V_x = C_x \frac{V_w}{C_w}\]</span>
<span>\[V_y = C_y \frac{V_h}{C_h}\]</span>
En donde C hace refenrencia al tamaño del plano que se esta usando y V es el tamaño de la pantalla real sobre la cual se proyectara la imagen. Con esta relación se puede determinar un pixel por cada una de los puntos en le plano sobre el cual se dibujara lo que es interceptado por los rayos.
El siguiente paso es disparar un rayo por cada uno de los puntos en el plano desde el punto focal, para esto se utiliza la ecuación paramétrica de la recta en tres dimensiones y además se parte de un punto O que será el origen o el punto focal y se dispara hacia cada uno de los puntos de V es decir del plano sobre el cual se dibujara. A continuación se mostrará la ecuación de la recta en donde se puede representar cualquier punto P y ademas t señala el recorrido del rayo :
<span>\[P = \vec{O} + t(\vec{V} - \vec{O})\]</span>
Como se renderizaran esferas, es necesario definir estas de forma matemática, por lo que se parte de que las esferas tiene un centro y un radio y al tener se puede definir que la relación que existe entre el punto del plano de proyección y el centro de la esfera, al juntar esta ecuación con la del rayo y al reemplazar V - O por el vector D, es decir la dirección del vector, se obtiene la siguiente ecuación en donde el simbolo &lt;> representa el producto punto:
<span>\[&lt;\vec{O} + t \vec{D} - \vec{C} , \vec{O} + t \vec{D} - \vec{C} > = r^2\]</span>
Al desarrollar estas ecuaciones es posible llegar a que la distancia entre los puntos y el punto focal se puede resolver mediante ecuaciones cuadráticas como se ilustra en la siguiente figura:</p><p align=center><img src=/project/sketches/ray3.png width=300></p><p>Con la finalidad de realizar un renderizado correcto de la luz también es necesario tener en cuenta la luz ambiental o la luz especular que llega a un punto P dado, para lo cual cada uno de los puntos requieren de un vector normal N, este sera necesario para computar a intensidad de la luz en cada uno de los puntos:
<span>\[I_P = I_A + \sum_{i=1}^n I_i \frac{&lt; \vec{N}, \vec{L_i}>}{| \vec{N}| | \vec{L_i}|}\]</span>
Ademas es necesarip definir que la esfera sobre la cual se refleja la luz tiene un vector normal para cada uno de los puntos, y este se puede hallar con el punto donde se quiere hallar la normal y el centro de la esfera:
<span>\[\vec{N} = \frac{P-C}{|P-C|}\]</span></p><p>Con todos estos elementos es posible presentar el resultado final en el cual se renderizan algunas esferas a las cuales la luz les llega desde un punto en la parte derecha de la pantalla:</p><details><summary>Ver Código</summary><div class=markdown-inner><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>canvas</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>canvas_context</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>canvas_pitch</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>canvas_buffer</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>viewport_size</span> ;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>projection_plane_z</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>camera_position</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>background_color</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>spheres</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lights</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>dy</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>incre</span> ; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>liSliderPInt</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>liSliderPX</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>liSliderPY</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setup</span>(){
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createCanvas</span>(<span style=color:#ae81ff>600</span>,<span style=color:#ae81ff>600</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>//console.log(drawingContext);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>canvas_buffer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>drawingContext</span>.<span style=color:#a6e22e>getImageData</span>(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas_pitch</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span><span style=color:#f92672>*</span><span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>viewport_size</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>projection_plane_z</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>camera_position</span> <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>background_color</span> <span style=color:#f92672>=</span> [<span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>255</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dy</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.2</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>incre</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPInt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createSlider</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0.2</span>, <span style=color:#ae81ff>0.05</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPInt</span>.<span style=color:#a6e22e>position</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPInt</span>.<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#e6db74>&#39;580px&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPX</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createSlider</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0.5</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPX</span>.<span style=color:#a6e22e>position</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>30</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPX</span>.<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#e6db74>&#39;580px&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPY</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createSlider</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0.5</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPY</span>.<span style=color:#a6e22e>position</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>50</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPY</span>.<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#e6db74>&#39;580px&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>spheres</span> <span style=color:#f92672>=</span> [<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Sphere</span>([<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>dy</span>, <span style=color:#ae81ff>3</span>], <span style=color:#ae81ff>0.2</span>, [<span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>])];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lights</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Light</span>(<span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>AMBIENT</span>,<span style=color:#ae81ff>0.2</span>),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Light</span>(<span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>POINT</span>, <span style=color:#a6e22e>liSliderPInt</span>.<span style=color:#a6e22e>value</span>(), [<span style=color:#a6e22e>liSliderPX</span>.<span style=color:#a6e22e>value</span>(), <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>]),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Light</span>(<span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>DIRECTIONAL</span>, <span style=color:#ae81ff>1</span>, [<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span> , <span style=color:#ae81ff>4</span>])
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>PutPixel</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>color</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>x</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>x</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>*</span><span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>canvas_pitch</span><span style=color:#f92672>*</span><span style=color:#a6e22e>y</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas_buffer</span>.<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>offset</span><span style=color:#f92672>++</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>color</span>[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas_buffer</span>.<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>offset</span><span style=color:#f92672>++</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>color</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas_buffer</span>.<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>offset</span><span style=color:#f92672>++</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>color</span>[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas_buffer</span>.<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>offset</span><span style=color:#f92672>++</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>255</span>; 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>UpdateCanvas</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>drawingContext</span>.<span style=color:#a6e22e>putImageData</span>(<span style=color:#a6e22e>canvas_buffer</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>v1</span>, <span style=color:#a6e22e>v2</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>2</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Length</span>(<span style=color:#a6e22e>vec</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>sqrt</span>(<span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>vec</span>, <span style=color:#a6e22e>vec</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Multiply</span>(<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>vec</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>k</span><span style=color:#f92672>*</span><span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>k</span><span style=color:#f92672>*</span><span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>1</span>], <span style=color:#a6e22e>k</span><span style=color:#f92672>*</span><span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>2</span>]];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>v1</span>, <span style=color:#a6e22e>v2</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>1</span>], <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>2</span>]];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Subtract</span>(<span style=color:#a6e22e>v1</span>, <span style=color:#a6e22e>v2</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>1</span>], <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>2</span>]];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Clamp</span>(<span style=color:#a6e22e>vec</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [Math.<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>255</span>, Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>0</span>])),
</span></span><span style=display:flex><span>        Math.<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>255</span>, Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>1</span>])),
</span></span><span style=display:flex><span>        Math.<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>255</span>, Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>2</span>]))];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Sphere</span>(<span style=color:#a6e22e>center</span>, <span style=color:#a6e22e>radius</span>, <span style=color:#a6e22e>color</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>center</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>center</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>radius</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>radius</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>color</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>color</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Light</span>(<span style=color:#a6e22e>ltype</span>, <span style=color:#a6e22e>intensity</span>, <span style=color:#a6e22e>position</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ltype</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ltype</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>intensity</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>intensity</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>position</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>position</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>AMBIENT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>POINT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>DIRECTIONAL</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>CanvasToViewport</span>(<span style=color:#a6e22e>p2d</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>p2d</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>*</span> <span style=color:#a6e22e>viewport_size</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p2d</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>*</span> <span style=color:#a6e22e>viewport_size</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>projection_plane_z</span>];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>IntersectRaySphere</span>(<span style=color:#a6e22e>origin</span>, <span style=color:#a6e22e>direction</span>, <span style=color:#a6e22e>sphere</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>oc</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Subtract</span>(<span style=color:#a6e22e>origin</span>, <span style=color:#a6e22e>sphere</span>.<span style=color:#a6e22e>center</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>k1</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>direction</span>, <span style=color:#a6e22e>direction</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>k2</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>oc</span>, <span style=color:#a6e22e>direction</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>k3</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>oc</span>, <span style=color:#a6e22e>oc</span>) <span style=color:#f92672>-</span> <span style=color:#a6e22e>sphere</span>.<span style=color:#a6e22e>radius</span><span style=color:#f92672>*</span><span style=color:#a6e22e>sphere</span>.<span style=color:#a6e22e>radius</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>discriminant</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>k2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>k2</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>*</span><span style=color:#a6e22e>k1</span><span style=color:#f92672>*</span><span style=color:#a6e22e>k3</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>discriminant</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> [<span style=color:#66d9ef>Infinity</span>, <span style=color:#66d9ef>Infinity</span>];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t1</span> <span style=color:#f92672>=</span> (<span style=color:#f92672>-</span><span style=color:#a6e22e>k2</span> <span style=color:#f92672>+</span> Math.<span style=color:#a6e22e>sqrt</span>(<span style=color:#a6e22e>discriminant</span>)) <span style=color:#f92672>/</span> (<span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>k1</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t2</span> <span style=color:#f92672>=</span> (<span style=color:#f92672>-</span><span style=color:#a6e22e>k2</span> <span style=color:#f92672>-</span> Math.<span style=color:#a6e22e>sqrt</span>(<span style=color:#a6e22e>discriminant</span>)) <span style=color:#f92672>/</span> (<span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>k1</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>t1</span>, <span style=color:#a6e22e>t2</span>];
</span></span><span style=display:flex><span>  }  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ComputeLighting</span>(<span style=color:#a6e22e>point</span>, <span style=color:#a6e22e>normal</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>intensity</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>length_n</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Length</span>(<span style=color:#a6e22e>normal</span>);  <span style=color:#75715e>// Should be 1.0, but just in case...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>lights</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>light</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lights</span>[<span style=color:#a6e22e>i</span>];
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>ltype</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>AMBIENT</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>intensity</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>intensity</span>;
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>vec_l</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>ltype</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>POINT</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>vec_l</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Subtract</span>(<span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>position</span>, <span style=color:#a6e22e>point</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {  <span style=color:#75715e>// Light.DIRECTIONAL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>vec_l</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>position</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>n_dot_l</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>normal</span>, <span style=color:#a6e22e>vec_l</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>n_dot_l</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>intensity</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>intensity</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>n_dot_l</span> <span style=color:#f92672>/</span> (<span style=color:#a6e22e>length_n</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>Length</span>(<span style=color:#a6e22e>vec_l</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>intensity</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>TraceRay</span>(<span style=color:#a6e22e>origin</span>, <span style=color:#a6e22e>direction</span>, <span style=color:#a6e22e>min_t</span>, <span style=color:#a6e22e>max_t</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>closest_t</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>Infinity</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>closest_sphere</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>spheres</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ts</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>IntersectRaySphere</span>(<span style=color:#a6e22e>origin</span>, <span style=color:#a6e22e>direction</span>, <span style=color:#a6e22e>spheres</span>[<span style=color:#a6e22e>i</span>]);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>closest_t</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>min_t</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>max_t</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>closest_t</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>closest_sphere</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>spheres</span>[<span style=color:#a6e22e>i</span>];
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>closest_t</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>min_t</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>max_t</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>closest_t</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>closest_sphere</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>spheres</span>[<span style=color:#a6e22e>i</span>];
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>closest_sphere</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>background_color</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>point</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>origin</span>, <span style=color:#a6e22e>Multiply</span>(<span style=color:#a6e22e>closest_t</span>, <span style=color:#a6e22e>direction</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>normal</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Subtract</span>(<span style=color:#a6e22e>point</span>, <span style=color:#a6e22e>closest_sphere</span>.<span style=color:#a6e22e>center</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>normal</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Multiply</span>(<span style=color:#ae81ff>1.0</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>Length</span>(<span style=color:#a6e22e>normal</span>), <span style=color:#a6e22e>normal</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Multiply</span>(<span style=color:#a6e22e>ComputeLighting</span>(<span style=color:#a6e22e>point</span>, <span style=color:#a6e22e>normal</span>), <span style=color:#a6e22e>closest_sphere</span>.<span style=color:#a6e22e>color</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>draw</span>(){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>x</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>x</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>y</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>y</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>direction</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>CanvasToViewport</span>([<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>])
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>color</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TraceRay</span>(<span style=color:#a6e22e>camera_position</span>, <span style=color:#a6e22e>direction</span>, <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>Infinity</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PutPixel</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>Clamp</span>(<span style=color:#a6e22e>color</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>incre</span>){
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>dy</span><span style=color:#f92672>+=</span><span style=color:#ae81ff>0.01</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>dy</span><span style=color:#f92672>&gt;=</span><span style=color:#ae81ff>1</span>){
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>incre</span><span style=color:#f92672>=</span><span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>      }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>dy</span><span style=color:#f92672>-=</span><span style=color:#ae81ff>0.01</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>dy</span><span style=color:#f92672>&lt;=-</span><span style=color:#ae81ff>1</span>){
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>incre</span><span style=color:#f92672>=</span><span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>spheres</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>center</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>dy</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lights</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>intensity</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>liSliderPInt</span>.<span style=color:#a6e22e>value</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lights</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>position</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>=</span> <span style=color:#a6e22e>liSliderPX</span>.<span style=color:#a6e22e>value</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lights</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>position</span>[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>=</span> <span style=color:#a6e22e>liSliderPY</span>.<span style=color:#a6e22e>value</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>UpdateCanvas</span>();
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></div></details><iframe id=rayTracingtest style=width:620px;height:625px srcdoc="
        <!DOCTYPE html>
        <html>
          <head>
            <script src=https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/p5.min.js></script>
            <script src=https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/addons/p5.sound.min.js></script>
            
            
            
            
            
            <script src=/project/sketches/rayTracingtest.js></script>
          </head>
          <body>
          </body>
        </html>
      "></iframe>
<details><summary>Ver Código</summary><div class=markdown-inner><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>canvas</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>canvas_context</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>canvas_pitch</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>canvas_buffer</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>viewport_size</span> ;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>projection_plane_z</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>camera_position</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>background_color</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>spheres</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lights</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>dy</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>incre</span> ; 
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>dx</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>increx</span> ; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>liSliderPInt</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>liSliderPX</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>liSliderPY</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setup</span>(){
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createCanvas</span>(<span style=color:#ae81ff>600</span>,<span style=color:#ae81ff>600</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>//console.log(drawingContext);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>canvas_buffer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>drawingContext</span>.<span style=color:#a6e22e>getImageData</span>(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas_pitch</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span><span style=color:#f92672>*</span><span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>viewport_size</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>projection_plane_z</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>camera_position</span> <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>background_color</span> <span style=color:#f92672>=</span> [<span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>255</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dy</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.2</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>incre</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dx</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>0.6</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>increx</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPInt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createSlider</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0.2</span>, <span style=color:#ae81ff>0.05</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPInt</span>.<span style=color:#a6e22e>position</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPInt</span>.<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#e6db74>&#39;580px&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPX</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createSlider</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0.5</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPX</span>.<span style=color:#a6e22e>position</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>30</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPX</span>.<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#e6db74>&#39;580px&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPY</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createSlider</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0.5</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPY</span>.<span style=color:#a6e22e>position</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>50</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>liSliderPY</span>.<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#e6db74>&#39;580px&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>spheres</span> <span style=color:#f92672>=</span> [<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Sphere</span>([<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>dy</span>, <span style=color:#ae81ff>3</span>], <span style=color:#ae81ff>0.2</span>, [<span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>]),
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Sphere</span>([<span style=color:#a6e22e>dx</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.2</span> , <span style=color:#ae81ff>5</span>], <span style=color:#ae81ff>0.8</span>, [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>0</span>]),
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Sphere</span>([<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>7</span>], <span style=color:#ae81ff>2</span>, [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>255</span>])];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lights</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Light</span>(<span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>AMBIENT</span>,<span style=color:#ae81ff>0.2</span>),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Light</span>(<span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>POINT</span>, <span style=color:#a6e22e>liSliderPInt</span>.<span style=color:#a6e22e>value</span>(), [<span style=color:#a6e22e>liSliderPX</span>.<span style=color:#a6e22e>value</span>(), <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>]),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Light</span>(<span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>DIRECTIONAL</span>, <span style=color:#ae81ff>1</span>, [<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span> , <span style=color:#ae81ff>4</span>])
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>PutPixel</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>color</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>x</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>x</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>*</span><span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>canvas_pitch</span><span style=color:#f92672>*</span><span style=color:#a6e22e>y</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas_buffer</span>.<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>offset</span><span style=color:#f92672>++</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>color</span>[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas_buffer</span>.<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>offset</span><span style=color:#f92672>++</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>color</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas_buffer</span>.<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>offset</span><span style=color:#f92672>++</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>color</span>[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canvas_buffer</span>.<span style=color:#a6e22e>data</span>[<span style=color:#a6e22e>offset</span><span style=color:#f92672>++</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>255</span>; 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>UpdateCanvas</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>drawingContext</span>.<span style=color:#a6e22e>putImageData</span>(<span style=color:#a6e22e>canvas_buffer</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>v1</span>, <span style=color:#a6e22e>v2</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>2</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Length</span>(<span style=color:#a6e22e>vec</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>sqrt</span>(<span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>vec</span>, <span style=color:#a6e22e>vec</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Multiply</span>(<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>vec</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>k</span><span style=color:#f92672>*</span><span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>k</span><span style=color:#f92672>*</span><span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>1</span>], <span style=color:#a6e22e>k</span><span style=color:#f92672>*</span><span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>2</span>]];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>v1</span>, <span style=color:#a6e22e>v2</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>1</span>], <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>2</span>]];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Subtract</span>(<span style=color:#a6e22e>v1</span>, <span style=color:#a6e22e>v2</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>1</span>], <span style=color:#a6e22e>v1</span>[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>v2</span>[<span style=color:#ae81ff>2</span>]];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Clamp</span>(<span style=color:#a6e22e>vec</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [Math.<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>255</span>, Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>0</span>])),
</span></span><span style=display:flex><span>        Math.<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>255</span>, Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>1</span>])),
</span></span><span style=display:flex><span>        Math.<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>255</span>, Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>vec</span>[<span style=color:#ae81ff>2</span>]))];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Sphere</span>(<span style=color:#a6e22e>center</span>, <span style=color:#a6e22e>radius</span>, <span style=color:#a6e22e>color</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>center</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>center</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>radius</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>radius</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>color</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>color</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Light</span>(<span style=color:#a6e22e>ltype</span>, <span style=color:#a6e22e>intensity</span>, <span style=color:#a6e22e>position</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ltype</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ltype</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>intensity</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>intensity</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>position</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>position</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>AMBIENT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>POINT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>DIRECTIONAL</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>CanvasToViewport</span>(<span style=color:#a6e22e>p2d</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>p2d</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>*</span> <span style=color:#a6e22e>viewport_size</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p2d</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>*</span> <span style=color:#a6e22e>viewport_size</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>projection_plane_z</span>];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>IntersectRaySphere</span>(<span style=color:#a6e22e>origin</span>, <span style=color:#a6e22e>direction</span>, <span style=color:#a6e22e>sphere</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>oc</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Subtract</span>(<span style=color:#a6e22e>origin</span>, <span style=color:#a6e22e>sphere</span>.<span style=color:#a6e22e>center</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>k1</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>direction</span>, <span style=color:#a6e22e>direction</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>k2</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>oc</span>, <span style=color:#a6e22e>direction</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>k3</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>oc</span>, <span style=color:#a6e22e>oc</span>) <span style=color:#f92672>-</span> <span style=color:#a6e22e>sphere</span>.<span style=color:#a6e22e>radius</span><span style=color:#f92672>*</span><span style=color:#a6e22e>sphere</span>.<span style=color:#a6e22e>radius</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>discriminant</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>k2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>k2</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>*</span><span style=color:#a6e22e>k1</span><span style=color:#f92672>*</span><span style=color:#a6e22e>k3</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>discriminant</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> [<span style=color:#66d9ef>Infinity</span>, <span style=color:#66d9ef>Infinity</span>];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t1</span> <span style=color:#f92672>=</span> (<span style=color:#f92672>-</span><span style=color:#a6e22e>k2</span> <span style=color:#f92672>+</span> Math.<span style=color:#a6e22e>sqrt</span>(<span style=color:#a6e22e>discriminant</span>)) <span style=color:#f92672>/</span> (<span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>k1</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t2</span> <span style=color:#f92672>=</span> (<span style=color:#f92672>-</span><span style=color:#a6e22e>k2</span> <span style=color:#f92672>-</span> Math.<span style=color:#a6e22e>sqrt</span>(<span style=color:#a6e22e>discriminant</span>)) <span style=color:#f92672>/</span> (<span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>k1</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>t1</span>, <span style=color:#a6e22e>t2</span>];
</span></span><span style=display:flex><span>  }  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ComputeLighting</span>(<span style=color:#a6e22e>point</span>, <span style=color:#a6e22e>normal</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>intensity</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>length_n</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Length</span>(<span style=color:#a6e22e>normal</span>);  <span style=color:#75715e>// Should be 1.0, but just in case...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>lights</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>light</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lights</span>[<span style=color:#a6e22e>i</span>];
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>ltype</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>AMBIENT</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>intensity</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>intensity</span>;
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>vec_l</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>ltype</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Light</span>.<span style=color:#a6e22e>POINT</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>vec_l</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Subtract</span>(<span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>position</span>, <span style=color:#a6e22e>point</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {  <span style=color:#75715e>// Light.DIRECTIONAL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>vec_l</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>position</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>n_dot_l</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DotProduct</span>(<span style=color:#a6e22e>normal</span>, <span style=color:#a6e22e>vec_l</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>n_dot_l</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>intensity</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>light</span>.<span style=color:#a6e22e>intensity</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>n_dot_l</span> <span style=color:#f92672>/</span> (<span style=color:#a6e22e>length_n</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>Length</span>(<span style=color:#a6e22e>vec_l</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>intensity</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>TraceRay</span>(<span style=color:#a6e22e>origin</span>, <span style=color:#a6e22e>direction</span>, <span style=color:#a6e22e>min_t</span>, <span style=color:#a6e22e>max_t</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>closest_t</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>Infinity</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>closest_sphere</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>spheres</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ts</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>IntersectRaySphere</span>(<span style=color:#a6e22e>origin</span>, <span style=color:#a6e22e>direction</span>, <span style=color:#a6e22e>spheres</span>[<span style=color:#a6e22e>i</span>]);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>closest_t</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>min_t</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>max_t</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>closest_t</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>closest_sphere</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>spheres</span>[<span style=color:#a6e22e>i</span>];
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>closest_t</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>min_t</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>max_t</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>closest_t</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ts</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>closest_sphere</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>spheres</span>[<span style=color:#a6e22e>i</span>];
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>closest_sphere</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>background_color</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>point</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>origin</span>, <span style=color:#a6e22e>Multiply</span>(<span style=color:#a6e22e>closest_t</span>, <span style=color:#a6e22e>direction</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>normal</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Subtract</span>(<span style=color:#a6e22e>point</span>, <span style=color:#a6e22e>closest_sphere</span>.<span style=color:#a6e22e>center</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>normal</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Multiply</span>(<span style=color:#ae81ff>1.0</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>Length</span>(<span style=color:#a6e22e>normal</span>), <span style=color:#a6e22e>normal</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Multiply</span>(<span style=color:#a6e22e>ComputeLighting</span>(<span style=color:#a6e22e>point</span>, <span style=color:#a6e22e>normal</span>), <span style=color:#a6e22e>closest_sphere</span>.<span style=color:#a6e22e>color</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>draw</span>(){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>x</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>x</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>y</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>y</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>direction</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>CanvasToViewport</span>([<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>])
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>color</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TraceRay</span>(<span style=color:#a6e22e>camera_position</span>, <span style=color:#a6e22e>direction</span>, <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>Infinity</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PutPixel</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>Clamp</span>(<span style=color:#a6e22e>color</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>incre</span>){
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>dy</span><span style=color:#f92672>+=</span><span style=color:#ae81ff>0.01</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>dy</span><span style=color:#f92672>&gt;=</span><span style=color:#ae81ff>1</span>){
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>incre</span><span style=color:#f92672>=</span><span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>      }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>dy</span><span style=color:#f92672>-=</span><span style=color:#ae81ff>0.01</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>dy</span><span style=color:#f92672>&lt;=-</span><span style=color:#ae81ff>1</span>){
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>incre</span><span style=color:#f92672>=</span><span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>increx</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dx</span><span style=color:#f92672>+=</span><span style=color:#ae81ff>0.01</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>dx</span><span style=color:#f92672>&gt;=</span><span style=color:#ae81ff>1</span>){
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>increx</span><span style=color:#f92672>=</span><span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>dx</span><span style=color:#f92672>-=</span><span style=color:#ae81ff>0.01</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>dx</span><span style=color:#f92672>&lt;=-</span><span style=color:#ae81ff>1</span>){
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>increx</span><span style=color:#f92672>=</span><span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>    }       
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>spheres</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>center</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>dy</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lights</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>intensity</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>liSliderPInt</span>.<span style=color:#a6e22e>value</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lights</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>position</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>=</span> <span style=color:#a6e22e>liSliderPX</span>.<span style=color:#a6e22e>value</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lights</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>position</span>[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>=</span> <span style=color:#a6e22e>liSliderPY</span>.<span style=color:#a6e22e>value</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>spheres</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>center</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>dx</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>UpdateCanvas</span>();
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></div></details><iframe id=rayTracingtestMultiple style=width:620px;height:625px srcdoc="
        <!DOCTYPE html>
        <html>
          <head>
            <script src=https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/p5.min.js></script>
            <script src=https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/addons/p5.sound.min.js></script>
            
            
            
            
            
            <script src=/project/sketches/rayTracingtestMultiple.js></script>
          </head>
          <body>
          </body>
        </html>
      "></iframe><h2 id=conclusiones-y-trabajo-futuro>Conclusiones y trabajo futuro
<a class=anchor href=#conclusiones-y-trabajo-futuro>#</a></h2><p>Se puede apreciar que es posible obtener unos efectos bastante realistas de luz cuando se aplica esta técnica para el renderizado las imágenes, igualmente se observa como aumenta el costo computacional al realizar las operaciones de ray casting lo cual puede llegar a ser un problema grave teniendo en cuenta que no se ha llegado a usar todos los efectos posibles como lo son por ejemplo los efectos de reflección de la luz o el manejo de diferentes figuras geométricas con diferentes materiales que puedan absorber mejor o peor la luz. Para el trabajo futuro se presenta la posibilidad de ampliar el programa incluyendo los efectos anteriormente mencionados pero también otros aún más importantes como lo son las sombras.</p><h2 id=recursos>Recursos
<a class=anchor href=#recursos>#</a></h2><ul><li>Gambetta, Gabriel (2021). Computer Graphs from scratch. A programmer&rsquo;s introduction to 3D rendering. No starch Press. San Francisco</li><li>Glassner, Andrew (2019). An Introduction to Ray Tracing. Academic Press, retomado de <a href=https://www.realtimerendering.com/raytracing/An-Introduction-to-Ray-Tracing-The-Morgan-Kaufmann-Series-in-Computer-Graphics-.pdf>https://www.realtimerendering.com/raytracing/An-Introduction-to-Ray-Tracing-The-Morgan-Kaufmann-Series-in-Computer-Graphics-.pdf</a></li><li>Redmon, Joe (2011). Ray Tracing. Trabajo de Tesís, Degree of Bachelor of Arts. Computer Science Department of Middlebury College, retomado de <a href=https://pjreddie.com/media/files/Redmon_Thesis.pdf>https://pjreddie.com/media/files/Redmon_Thesis.pdf</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://vcwork.github.io/project/commit/4ace9b54bbb484d1108834e4db9662ccc37a2dd4 title='Last modified by Gerson Pineda | June 15, 2022' target=_blank rel=noopener><img src=/project/svg/calendar.svg class=book-icon alt=Calendar>
<span>June 15, 2022</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#entrega-2---ray-tracing>Entrega 2 - Ray Tracing</a><ul><li><a href=#ray-tracing>Ray tracing</a></li><li><a href=#introducción>Introducción</a></li><li><a href=#contexto>Contexto</a><ul><li><a href=#historia>Historia</a></li><li><a href=#funcionamiento>Funcionamiento</a></li></ul></li><li><a href=#resultados>Resultados</a></li><li><a href=#conclusiones-y-trabajo-futuro>Conclusiones y trabajo futuro</a></li><li><a href=#recursos>Recursos</a></li></ul></li></ul></nav></div></aside></main></body></html>